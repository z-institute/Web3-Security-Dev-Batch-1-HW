# Week1 for Web3-Security-Dev-Batch-1-HW

### 完成 mint(address to, uint256 amount) function
- src/Token.sol

### 完成對應的測試
- test/Token.t.sol
- 印出每個 function 使用多少 gas
  | src/Token.sol:Token contract |                 |       |        |       |         |
  |------------------------------|-----------------|-------|--------|-------|---------|
  | Deployment Cost              | Deployment Size |       |        |       |         |
  | 500301                       | 3320            |       |        |       |         |
  | Function Name                | min             | avg   | median | max   | # calls |
  | allowance                    | 814             | 814   | 814    | 814   | 4       |
  | approve                      | 24739           | 24739 | 24739  | 24739 | 1       |
  | balanceOf                    | 562             | 562   | 562    | 562   | 15      |
  | mint                         | 25167           | 26767 | 25167  | 29967 | 3       |
  | transfer                     | 3288            | 3288  | 3288   | 3288  | 3       |
  | transferFrom                 | 4162            | 4162  | 4162   | 4162  | 1       |
- 印出每個 test function 使用多少 gas  
  ==> 參考 test_function_gas.txt
- expectRevert 之後的 token.transferFrom(user1, user2, token.balanceOf(user1)); 引發的 ERC20InsufficientAllowance 錯誤，forge 仍是沒 catch 到，拋出「call did not revert as expected」的提示

### 完成測試後，利用 Foundry 將合約部署至 Sepolia testnet
- test/Token.s.sol
```
forge script script/Token.s.sol:TokenScript --rpc-url="https://eth-sepolia.g.alchemy.com/v2/your_alchemy_api_key" --broadcast --verify -vvvv --optimizer-runs 200
```

### 成功部署後，驗證鏈上的合約
- contract creation address: 0xaFfB198193e8681f58DB28DBBaf72be91699Fb73 [link](https://sepolia.etherscan.io/address/0xaFfB198193e8681f58DB28DBBaf72be91699Fb73#code)

### 將前面的測試情境，用 Foundry 發出對應的交易到剛剛部署在測試鏈上的合約
- 8 transactions: 0xaFfB198193e8681f58DB28DBBaf72be91699Fb73 [link](https://sepolia.etherscan.io/address/0xaFfB198193e8681f58DB28DBBaf72be91699Fb73)
- 3 Mints, 2 Transfers, 1 Approve, 1 Transfer From

### 熟悉 cast CLI 工具
- gas usage
  | src/Token.sol:Token contract | Simulation      | Sepolia deploy  |
  |------------------------------|-----------------|-----------------|
  | Contract creation            | 500301          | 604361          | 
  | Token::mint (x3)             | 29967           | 51599           |
  | Token::transfer (x2)         | 12888           | 34520           |
  | Token::approve               | 24739           | 46371           |
  | Token::transferFrom          | 18562           | 40562           |
- 上鏈後的 gas usage 比本地模擬的多，可能的原因如下:  
  1. 本地foundry 框架模擬較為單純，不若主網及測試網複雜，有諸多影響 gas usage 的外部變因  
  2. 本地 EVM 運行的版本和主網及測試網不同，也會影響 gas usage
  3. deploy 合約時所使用的參數，如 --optimizer-runs 200，也會多少影響 gas usage
- 驗證每個角色的 balance 如預期，除了  
  1. user2 將 user1 的 2 個 token 轉移到 user3 身上，並將剩餘的 token 轉移給自己
  2. 因 allowance 不足，會導致 ERC20InsufficientAllowance revert
- 將 user1 的 balance 分別用 Ether、Gwei 為單位表示
  1. cast call 0xaFfB198193e8681f58DB28DBBaf72be91699Fb73 "balanceOf(address)(uint256)" --rpc-url="https://eth-sepolia.g.alchemy.com/v2/your_alchemy_api_key" 0x0278137e8E2C38111297c9991815507eB16eaf25 得到 6000000000000000000
  2. cast to-unit 6000000000000000000 gwei 得到 6000000000
  3. cast to-unit 6000000000000000000 ether 得到 6
- 將 user2 的 balance 用十六進位表示
  1. cast call 0xaFfB198193e8681f58DB28DBBaf72be91699Fb73 "balanceOf(address)(uint256)" --rpc-url="https://eth-sepolia.g.alchemy.com/v2/your_alchemy_api_key" 0x3cee49Aa0a6a489A81E18162449554983f3A3555 得到 1000000000000000000
  2. cast to-hex 10000000000000000000 得到 0x8ac7230489e80000
- 印出任意一個 tramsaction 的詳細資訊
  1. cast tx 0x5a27fc0ad10adcee38a483c9ced1a68026e826ebacd7259447ec175913b88a6d --rpc-url="https://eth-sepolia.g.alchemy.com/v2/your_alchemy_api_key"
  ```
  blockHash            0x2448b0a0dfe949cd2a3123f388e5d444dad44508cdee6effda492d4da0ba228e
  blockNumber          5325958
  from                 0x23a26A75550611d644B1f28358E23Cc4A0f9F101
  gas                  785398
  gasPrice             4526595172
  hash                 0x5a27fc0ad10adcee38a483c9ced1a68026e826ebacd7259447ec175913b88a6d
  input                0x60806040523480156200001157600080fd5b50604051806040016040528060058152602001642a37b5b2b760d91b81525060405180604001604052806002815260200161544b60f01b81525081600390816200005c9190620002cb565b5060046200006b8282620002cb565b505050620000a63362000083620000ac60201b60201c565b620000939060ff16600a620004ac565b620000a0906064620004c1565b620000b1565b620004f1565b601290565b6001600160a01b038216620000e15760405163ec442f0560e01b8152600060048201526024015b60405180910390fd5b620000ef60008383620000f3565b5050565b6001600160a01b03831662000122578060026000828254620001169190620004db565b90915550620001969050565b6001600160a01b03831660009081526020819052604090205481811015620001775760405163391434e360e21b81526001600160a01b03851660048201526024810182905260448101839052606401620000d8565b6001600160a01b03841660009081526020819052604090209082900390555b6001600160a01b038216620001b457600280548290039055620001d3565b6001600160a01b03821660009081526020819052604090208054820190555b816001600160a01b0316836001600160a01b03167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef836040516200021991815260200190565b60405180910390a3505050565b634e487b7160e01b600052604160045260246000fd5b600181811c908216806200025157607f821691505b6020821081036200027257634e487b7160e01b600052602260045260246000fd5b50919050565b601f821115620002c657600081815260208120601f850160051c81016020861015620002a15750805b601f850160051c820191505b81811015620002c257828155600101620002ad565b5050505b505050565b81516001600160401b03811115620002e757620002e762000226565b620002ff81620002f884546200023c565b8462000278565b602080601f8311600181146200033757600084156200031e5750858301515b600019600386901b1c1916600185901b178555620002c2565b600085815260208120601f198616915b82811015620003685788860151825594840194600190910190840162000347565b5085821015620003875787850151600019600388901b60f8161c191681555b5050505050600190811b01905550565b634e487b7160e01b600052601160045260246000fd5b600181815b80851115620003ee578160001904821115620003d257620003d262000397565b80851615620003e057918102915b93841c9390800290620003b2565b509250929050565b6000826200040757506001620004a6565b816200041657506000620004a6565b81600181146200042f57600281146200043a576200045a565b6001915050620004a6565b60ff8411156200044e576200044e62000397565b50506001821b620004a6565b5060208310610133831016604e8410600b84101617156200047f575081810a620004a6565b6200048b8383620003ad565b8060001904821115620004a257620004a262000397565b0290505b92915050565b6000620004ba8383620003f6565b9392505050565b8082028115828204841417620004a657620004a662000397565b80820180821115620004a657620004a662000397565b6107f780620005016000396000f3fe608060405234801561001057600080fd5b506004361061009e5760003560e01c806340c10f191161006657806340c10f191461011857806370a082311461012d57806395d89b4114610156578063a9059cbb1461015e578063dd62ed3e1461017157600080fd5b806306fdde03146100a3578063095ea7b3146100c157806318160ddd146100e457806323b872dd146100f6578063313ce56714610109575b600080fd5b6100ab6101aa565b6040516100b89190610641565b60405180910390f35b6100d46100cf3660046106ab565b61023c565b60405190151581526020016100b8565b6002545b6040519081526020016100b8565b6100d46101043660046106d5565b610256565b604051601281526020016100b8565b61012b6101263660046106ab565b61027a565b005b6100e861013b366004610711565b6001600160a01b031660009081526020819052604090205490565b6100ab610300565b6100d461016c3660046106ab565b61030f565b6100e861017f366004610733565b6001600160a01b03918216600090815260016020908152604080832093909416825291909152205490565b6060600380546101b990610766565b80601f01602080910402602001604051908101604052809291908181526020018280546101e590610766565b80156102325780601f1061020757610100808354040283529160200191610232565b820191906000526020600020905b81548152906001019060200180831161021557829003601f168201915b5050505050905090565b60003361024a81858561031d565b60019150505b92915050565b60003361026485828561032f565b61026f8585856103ad565b506001949350505050565b33600090815260208190526040902054678ac7230489e800009061029f9083906107a0565b11156102f25760405162461bcd60e51b815260206004820152601e60248201527f596f752063616e206f6e6c79206d696e74206c657373207468616e203130000060448201526064015b60405180910390fd5b6102fc828261040c565b5050565b6060600480546101b990610766565b60003361024a8185856103ad565b61032a8383836001610442565b505050565b6001600160a01b0383811660009081526001602090815260408083209386168352929052205460001981146103a7578181101561039857604051637dc7a0d960e11b81526001600160a01b038416600482015260248101829052604481018390526064016102e9565b6103a784848484036000610442565b50505050565b6001600160a01b0383166103d757604051634b637e8f60e11b8152600060048201526024016102e9565b6001600160a01b0382166104015760405163ec442f0560e01b8152600060048201526024016102e9565b61032a838383610517565b6001600160a01b0382166104365760405163ec442f0560e01b8152600060048201526024016102e9565b6102fc60008383610517565b6001600160a01b03841661046c5760405163e602df0560e01b8152600060048201526024016102e9565b6001600160a01b03831661049657604051634a1406b160e11b8152600060048201526024016102e9565b6001600160a01b03808516600090815260016020908152604080832093871683529290522082905580156103a757826001600160a01b0316846001600160a01b03167f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b9258460405161050991815260200190565b60405180910390a350505050565b6001600160a01b03831661054257806002600082825461053791906107a0565b909155506105b49050565b6001600160a01b038316600090815260208190526040902054818110156105955760405163391434e360e21b81526001600160a01b038516600482015260248101829052604481018390526064016102e9565b6001600160a01b03841660009081526020819052604090209082900390555b6001600160a01b0382166105d0576002805482900390556105ef565b6001600160a01b03821660009081526020819052604090208054820190555b816001600160a01b0316836001600160a01b03167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef8360405161063491815260200190565b60405180910390a3505050565b600060208083528351808285015260005b8181101561066e57858101830151858201604001528201610652565b506000604082860101526040601f19601f8301168501019250505092915050565b80356001600160a01b03811681146106a657600080fd5b919050565b600080604083850312156106be57600080fd5b6106c78361068f565b946020939093013593505050565b6000806000606084860312156106ea57600080fd5b6106f38461068f565b92506107016020850161068f565b9150604084013590509250925092565b60006020828403121561072357600080fd5b61072c8261068f565b9392505050565b6000806040838503121561074657600080fd5b61074f8361068f565b915061075d6020840161068f565b90509250929050565b600181811c9082168061077a57607f821691505b60208210810361079a57634e487b7160e01b600052602260045260246000fd5b50919050565b8082018082111561025057634e487b7160e01b600052601160045260246000fdfea2646970667358221220003897e03d2d2bd557ee587e908009dab62df6b973bc2a4b014df1e5d7cc8c0f64736f6c63430008140033
  nonce                4
  r                    0x9210b8fb7d77d1f5fd43c45149f68ba517dea976057ebca40d45d1fc94d06f7f
  s                    0x4b7108f256217dad4fc0ca72eb8f86ba15b13c53ec479b8973444ad8cc03aa48
  to                   
  transactionIndex     67
  v                    0
  value                0
  yParity              0
  ```