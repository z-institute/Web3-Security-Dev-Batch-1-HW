# DaoToken

## Vulnerability Analysis

```js
    function delegate(address _addr) external {
        // msg.sender: 0x0000000000000000000000000000000000000001
        // hacker: 0x0000000000000000000000000000000000001337
        return _delegate(msg.sender, _addr);
    }
    function _delegate(address _addr, address delegatee) internal {
        address currentDelegate = _delegates[_addr]; // 還沒設定前 _delegates[_addr] 還是空 所以回傳遞只會是 0x0000000000000000000000000000000000000000
        uint256 _addrBalance = balanceOf(_addr);
        _delegates[_addr] = delegatee;
        _moveDelegates(currentDelegate, delegatee, _addrBalance);
    }
    function _moveDelegates(address from, address to, uint256 amount) internal {
        if (from != to && amount > 0) {
            if (from != address(0)) {
                uint32 fromNum = numCheckpoints[from];
                uint256 fromOld = fromNum > 0 ? checkpoints[from][fromNum - 1].votes : 0;
                uint256 fromNew = fromOld - amount;
                _writeCheckpoint(from, fromNum, fromOld, fromNew);
            }

            if (to != address(0)) {
                uint32 toNum = numCheckpoints[to];
                uint256 toOld = toNum > 0 ? checkpoints[to][toNum - 1].votes : 0;
                uint256 toNew = toOld + amount;
                _writeCheckpoint(to, toNum, toOld, toNew);
            }
        }
    }
```

-DaoToken contract 裡的 function \_delegate 有個 uint256 \_addrBalance = balanceOf(\_addr); -這個會造成 transfer token to others 可以無限 DELEGATE votes. -覺得 ERC 20 transfer() 可以改寫 來 UPDATE DELEGATE

### Mitigation

group question6 and question10 in W2Group.t.sol
